#!/bin/bash
#
# nome............: validateMaps
# versão..........: 0.6
# descrição.......: Valida se os servidores secundários estão com os mapas atualizados
# criado em.......: 10/11/2022
# criado por......: Alan da Silva Alves
# atualizado em...: 16/11/2022
#                   ambiente de testes e produção
# atualizado em...: 13/11/2022
#                   testa a existência dos arquivos
#                   trata e melhora a saída de erro
# atualizado em...: 11/11/2022
#                   códido foi refatorado
#                   sistema de logs implementado
#
# ------------------------------------------------------------------------------------- #

# ------------------------------------------------------------------------------------- #
# Base inicial do sistema
# ------------------------------------------------------------------------------------- #

dominio='cientifico.empresa.corp'
mapas=$(ls /var/yp/cientifico.empresa.corp)
primario='perola.empresa.corp'

# template ansible vai identificar o nome do host
secundario='{{ inventory_hostname }}'

# Ambiente de produção e testes
# mode='Prod'
mode='Test'
mapa_desatualizado='/usr/share/nis_example_test.txt'

# Variáveis para logs de sucesso, falhas e erros inesperados
data=$(date "+%Y %b %a %e %T")
logs_de_conformidade='/var/log/conformidade_maps.log'
# Messagens de logs
SUCESSO='SUCESSO: Os mapas estão atualizados.'
FALHA='FALHA: Os mapas NÃO estão atualizados!'
FALHA_TEST='FALHA TESTE: Os mapas NÃO estão atualizados!'
ERRO='ERRO: Erro inesperado no sistema!'

# ------------------------------------------------------------------------------------- #
# Funções de uso do sistema
# ------------------------------------------------------------------------------------- #

# Apaga os relatórios dos mapas antigos
function apaga_report_antigo() {
    report_old=$(ls /tmp/report_* 2> /dev/null)

    if [[ ${report_old} ]]; then
        rm /tmp/report_*
    fi
}

# Testa se os arquivos reports existem antes da comparação
function testa_report_existe() {
    file_master=${1}
    file_slave=${2}

    if [[ ( -f ${file_master} ) ]] && [[ ( -f ${file_slave} ) ]]; then
        echo "True"
    elif [[ ( -f ${file_master} ) ]]; then
        echo "File: $file_slave não existe!"
    elif [[ ( -f ${file_slave} ) ]]; then
        echo "File: $file_master não existe"
    else
        echo "Files: $file_master e $file_slave não existe!"
    fi
}

# Gera relatórios dos mapas consultados usando o comando yppoll
function gera_report() {
    server=${1}

    for mapa in $mapas; do
       /usr/sbin/yppoll -h ${server} -d ${dominio} ${mapa} >> /tmp/report_${server}.txt
    done
}

# Compara a diferença dos mapas do master e dos slave
function compara_diferenca() {
    file_master_path="/tmp/report_${1}.txt"
    file_slave_path="/tmp/report_${2}.txt"
    result_test=$(testa_report_existe ${file_master_path} ${file_slave_path})

    if [[ ${result_test} = 'True' ]]; then
        diff --color=always --unified=0 ${file_master_path} ${file_slave_path}
    else
        echo ${result_test}
        exit 1
    fi
}

# Retorna o resultado a partir da diferença, qualquer valor retornado indica uma
# falha do processo ou erro inesperado.
# A falha é filtrada pelo order number para mapas desatualizados no slave
function retorna_resultado() {
    return_diff=$(compara_diferenca ${primario} ${secundario})
    order_number=$(echo "${return_diff}" | grep 'order number')

    if [[ ${return_diff} ]] && [[ ${order_number} ]]; then
        echo "${return_diff}" | tee -a $logs_de_conformidade
        echo "${data} - ${HOSTNAME} - ${FALHA}" | tee -a $logs_de_conformidade
    elif [[ ${return_diff} ]]; then
        echo "${return_diff}" | tee -a $logs_de_conformidade
        echo "${data} - ${HOSTNAME} - ${ERRO}" | tee -a $logs_de_conformidade
    else
        echo "${data} - ${HOSTNAME} - ${SUCESSO}" | tee -a $logs_de_conformidade
    fi
}

# ------------------------------------------------------------------------------------- #
# Execução principal do sistema
# ------------------------------------------------------------------------------------- #

if [[ ${mode} = 'Prod' ]]; then
    apaga_report_antigo
    gera_report ${primario}
    gera_report ${secundario}
    retorna_resultado
else
    apaga_report_antigo
    gera_report ${primario}
    cp ${mapa_desatualizado} /tmp/report_${secundario}.txt
    echo "${data} - ${HOSTNAME} - ${FALHA_TEST}" | tee -a $logs_de_conformidade
    retorna_resultado
    echo "${data} - ${HOSTNAME} - ${FALHA_TEST}" | tee -a $logs_de_conformidade
fi
